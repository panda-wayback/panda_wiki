# ROS2 节点基础

> 本文档介绍ROS2节点的基本概念和创建方法，适合ROS2初学者学习。

---

## 📋 目录
- [什么是ROS2节点](#什么是ros2节点)
- [节点类的概念](#节点类的概念)
- [创建节点的逻辑流程](#创建节点的逻辑流程)
- [创建节点的基本要素](#创建节点的基本要素)
- [代码实现](#代码实现)
- [代码实现解析](#代码实现解析)
- [节点的生命周期](#节点的生命周期)
- [运行节点](#运行节点)
- [关键概念总结](#关键概念总结)
- [下一步学习](#下一步学习)

---

## 🎯 什么是ROS2节点？

ROS2节点（Node）是ROS2系统中的**基本计算单元**，每个节点都是一个独立的进程，负责执行特定的功能。

### 🔧 节点的作用
| 作用 | 说明 |
|------|------|
| **执行任务** | 每个节点负责执行特定的功能，比如传感器数据采集、数据处理、控制指令发送等 |
| **模块化设计** | 将复杂的机器人系统分解为多个独立的节点，每个节点专注于一个功能 |
| **通信桥梁** | 节点之间通过话题、服务等方式进行数据交换和协作 |

### ✨ 节点的特点
- 🚀 **独立性**：每个节点都是独立的进程，可以单独启动、停止和重启
- 🧩 **模块化**：不同的功能被分解到不同的节点中，便于开发和维护
- 🌐 **分布式**：节点可以运行在不同的机器上，通过网络进行通信
- 🔄 **可重用性**：节点可以在不同的机器人系统中重复使用

---

## 🏗️ 节点类的概念

### 什么是节点类？
节点类是一个继承自ROS2 Node基类的Python类，它定义了节点的具体行为。就像**设计图纸**一样，节点类描述了节点应该做什么、怎么做。

### 🎯 节点类的作用
| 作用 | 说明 |
|------|------|
| **封装功能** | 把节点的所有功能都封装在一个类里面 |
| **定义行为** | 指定节点启动时做什么、运行时做什么 |
| **管理状态** | 保存节点运行过程中需要的数据 |

---

## 🔄 创建节点的逻辑流程

### 📝 伪代码展示

```python
# 1. 定义节点类
class 我的节点(Node):
    def __init__(self):
        # 设置节点名称
        # 创建需要的组件（定时器、订阅者等）
        # 输出启动信息
    
    def 定时任务(self):
        # 定期执行的任务
        # 比如输出心跳信息

# 2. 主函数流程
def main():
    # 初始化ROS2系统
    # 创建节点实例
    # 启动节点运行
    # 处理异常
    # 清理资源

# 3. 程序入口
if __name__ == '__main__':
    main()
```

### 🎯 关键逻辑点
1. **节点类定义**：继承Node基类，实现自己的功能
2. **初始化设置**：在`__init__`中设置节点名称和创建组件
3. **主函数管理**：负责启动、运行、关闭整个流程
4. **异常处理**：确保节点能够优雅地启动和关闭

---

## 🧩 创建节点的基本要素

### 1️⃣ 节点类（Node Class）
节点类是一个继承自ROS2 Node基类的Python类，它定义了节点的具体行为。

**作用**：
- 封装节点的所有功能
- 定义节点的初始化逻辑
- 实现节点的具体行为（如定时任务、数据处理等）

### 2️⃣ 节点名称
每个节点都必须有一个唯一的名称，用于在ROS2系统中标识这个节点。

**作用**：
- 在ROS2系统中唯一标识节点
- 其他节点可以通过名称找到这个节点
- 便于调试和监控

### 3️⃣ 初始化函数
初始化函数在节点启动时执行，用于设置节点的基本配置。

**作用**：
- 设置节点名称
- 创建定时器、订阅者、发布者等
- 输出初始化日志

### 4️⃣ 主函数
主函数是节点的入口点，负责启动和运行节点。

**作用**：
- 初始化ROS2系统
- 创建节点实例
- 启动节点运行
- 处理异常和清理资源

### 5️⃣ 生命周期管理
节点有明确的启动、运行和关闭过程。

**三个阶段**：
- **初始化**：设置节点环境
- **运行**：执行节点功能
- **清理**：释放资源

---

## 💻 代码实现

现在让我们看看如何用真实的Python代码实现上面的逻辑：

```python
#!/usr/bin/env python3
"""
01_simple_node - 最简单的ROS2节点示例

这个节点演示了ROS2节点的基本结构：
1. 导入必要的ROS2库
2. 创建节点类
3. 初始化节点
4. 运行节点

学习目标：
- 理解ROS2节点的基本概念
- 掌握节点的创建和运行流程
- 了解节点的生命周期
"""

import rclpy
from rclpy.node import Node


class SimpleNode(Node):
    """
    最简单的ROS2节点类
    
    这个类继承自Node基类，实现了最基本的节点功能：
    - 节点初始化
    - 基本的日志输出
    - 定时器回调
    """
    
    def __init__(self):
        """
        节点初始化函数
        
        在这里我们：
        1. 调用父类构造函数，设置节点名称
        2. 创建定时器，定期执行回调函数
        3. 输出初始化日志
        """
        # 调用父类构造函数，设置节点名称为 'simple_node'
        # 节点名称在ROS2系统中必须是唯一的
        super().__init__('simple_node')
        
        # 输出初始化日志
        self.get_logger().info('01_simple_node 已启动！')
        self.get_logger().info('这是一个最简单的ROS2节点示例')
        
        # 创建定时器，每1秒执行一次timer_callback函数
        # 定时器是ROS2中常用的机制，用于周期性执行任务
        self.timer = self.create_timer(1.0, self.timer_callback)
        
        # 输出定时器创建成功的日志
        self.get_logger().info('定时器已创建，每秒执行一次回调')
    
    def timer_callback(self):
        """
        定时器回调函数
        
        这个函数会被定时器定期调用，用于：
        - 输出心跳信息
        - 演示节点的持续运行
        - 显示当前时间戳
        """
        # 获取当前时间戳
        current_time = self.get_clock().now()
        
        # 输出心跳信息
        self.get_logger().info(f'节点正在运行... 时间戳: {current_time}')


def main(args=None):
    """
    主函数 - 节点的入口点
    
    这个函数负责：
    1. 初始化ROS2客户端库
    2. 创建节点实例
    3. 运行节点
    4. 处理异常和清理资源
    """
    # 初始化ROS2客户端库
    # 这是使用ROS2功能的必要步骤
    rclpy.init(args=args)
    
    try:
        # 创建SimpleNode实例
        simple_node = SimpleNode()
        
        # 输出启动信息
        simple_node.get_logger().info('开始运行节点...')
        
        # 运行节点，开始处理回调
        # spin()函数会让节点持续运行，直到被中断
        rclpy.spin(simple_node)
        
    except KeyboardInterrupt:
        # 处理键盘中断（Ctrl+C）
        print('\n收到中断信号，正在关闭节点...')
        
    except Exception as e:
        # 处理其他异常
        print(f'节点运行出错: {e}')
        
    finally:
        # 清理资源
        # 销毁节点实例
        if 'simple_node' in locals():
            simple_node.destroy_node()
        
        # 关闭ROS2客户端库
        rclpy.shutdown()
        
        print('节点已关闭，程序结束')


if __name__ == '__main__':
    """
    程序入口点
    
    当直接运行这个Python文件时，会执行main()函数
    这是Python的标准做法
    """
    main()
```

---

## 🔍 代码实现解析

### 1️⃣ 节点类的实现
```python
class SimpleNode(Node):
    def __init__(self):
        super().__init__('simple_node')
```
**对应伪代码**：`class 我的节点(Node):` 和 `# 设置节点名称`
- 创建了一个继承自Node的类
- 在初始化时设置了节点名称为'simple_node'

### 2️⃣ 初始化函数的实现
```python
def __init__(self):
    super().__init__('simple_node')
    self.get_logger().info('01_simple_node 已启动！')
    self.timer = self.create_timer(1.0, self.timer_callback)
```
**对应伪代码**：`# 创建需要的组件（定时器、订阅者等）` 和 `# 输出启动信息`
- 设置节点名称
- 创建定时器（节点的具体功能）
- 输出初始化日志

### 3️⃣ 主函数的实现
```python
def main(args=None):
    rclpy.init(args=args)
    simple_node = SimpleNode()
    rclpy.spin(simple_node)
    rclpy.shutdown()
```
**对应伪代码**：主函数流程中的各个步骤
- `rclpy.init()`：初始化阶段
- `rclpy.spin()`：运行阶段
- `rclpy.shutdown()`：清理阶段

---

## ⏰ 节点的生命周期

节点的生命周期分为三个阶段，每个阶段都有特定的任务：

### 🔧 1. 初始化阶段
- 导入必要的库
- 初始化ROS2客户端库（`rclpy.init()`）
- 创建节点实例

### 🚀 2. 运行阶段
- 节点开始处理回调（`rclpy.spin()`）
- 执行定时器回调、话题回调等
- 持续运行直到被中断

### 🧹 3. 清理阶段
- 销毁节点实例（`destroy_node()`）
- 关闭ROS2客户端库（`rclpy.shutdown()`）

---

## 🚀 运行节点

### 📝 1. 保存代码
将上述代码保存为`simple_node.py`文件。

### 🔧 2. 设置权限
```bash
chmod +x simple_node.py
```

### ▶️ 3. 运行节点
```bash
python3 simple_node.py
```

### 📊 4. 查看输出
你应该能看到类似以下的输出：
```bash
[INFO] [simple_node]: 01_simple_node 已启动！
[INFO] [simple_node]: 这是一个最简单的ROS2节点示例
[INFO] [simple_node]: 定时器已创建，每秒执行一次回调
[INFO] [simple_node]: 开始运行节点...
[INFO] [simple_node]: 节点正在运行... 时间戳: 1234567890.123456
```

### ⏹️ 5. 停止节点
按`Ctrl+C`停止节点运行。

---

## 📚 关键概念总结

### 🏷️ 节点名称
- 每个节点必须有唯一的名称
- 名称用于在ROS2系统中标识节点
- 可以通过`ros2 node list`命令查看所有运行的节点

### 📝 日志系统
- 使用`self.get_logger()`获取日志对象
- 支持不同级别的日志：`info`、`warn`、`error`、`debug`
- 日志会显示节点名称和时间戳

### ⏱️ 定时器
- 用于周期性执行任务
- 可以设置执行频率（秒为单位）
- 回调函数在单独的线程中执行

### 🛡️ 异常处理
- 使用`try-except-finally`结构处理异常
- 确保资源正确清理
- 优雅地处理中断信号

---

## 🎯 下一步学习

掌握了基本的节点概念后，你可以继续学习：

| 主题 | 说明 |
|------|------|
| **话题（Topic）** | 学习如何发布和订阅消息 |
| **服务（Service）** | 学习如何实现请求和响应机制 |
| **参数（Parameter）** | 学习如何使用和配置节点参数 |
| **启动文件** | 学习如何配置和启动多个节点 |

> 💡 **提示**：这个简单的节点示例为理解ROS2的核心概念奠定了基础，后续的复杂功能都建立在这个基础之上。
